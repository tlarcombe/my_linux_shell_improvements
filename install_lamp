#!/bin/bash

# Exit on any error
set -e

# Variables
USER="***your_username_here***"
DOMAIN="***your_servername_here***"
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 24)  # Generate random MySQL root password
MYSQL_PHPMYADMIN_PASSWORD=$(openssl rand -base64 24)  # Generate random phpMyAdmin user password

# Function to display installation progress
echo_progress() {
    echo "===> $1"
}

# Update package list
echo_progress "Updating package list"
apt update

# Install Apache
echo_progress "Installing Apache2"
apt install -y apache2
systemctl enable apache2
systemctl start apache2

# Install MySQL
echo_progress "Installing MySQL"
apt install -y mysql-server
systemctl enable mysql
systemctl start mysql

# Secure MySQL installation - Updated section
echo_progress "Securing MySQL installation"
# First, set root password using ALTER USER only if using auth_socket
mysql --user=root <<EOF
ALTER USER 'root'@'localhost' IDENTIFIED WITH auth_socket;
CREATE USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASSWORD}';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
CREATE USER 'phpmyadmin'@'localhost' IDENTIFIED BY '${MYSQL_PHPMYADMIN_PASSWORD}';
GRANT ALL PRIVILEGES ON *.* TO 'phpmyadmin'@'localhost' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOF

# Install PHP and required modules
echo_progress "Installing PHP and modules"
apt install -y php libapache2-mod-php php-mysql php-cli php-common php-zip php-gd php-mbstring php-curl php-xml php-pear php-bcmath

# Install phpMyAdmin
echo_progress "Installing phpMyAdmin"
apt install -y phpmyadmin

# Configure Apache virtual hosts
echo_progress "Configuring virtual hosts"

# Create test1 virtual host
cat > /etc/apache2/sites-available/test1.${DOMAIN}.conf <<EOF
<VirtualHost *:80>
    ServerName test1.${DOMAIN}
    DocumentRoot /var/www/test1.${DOMAIN}
    ErrorLog \${APACHE_LOG_DIR}/test1.${DOMAIN}_error.log
    CustomLog \${APACHE_LOG_DIR}/test1.${DOMAIN}_access.log combined
</VirtualHost>
EOF

# Create test2 virtual host
cat > /etc/apache2/sites-available/test2.${DOMAIN}.conf <<EOF
<VirtualHost *:80>
    ServerName test2.${DOMAIN}
    DocumentRoot /var/www/test2.${DOMAIN}
    ErrorLog \${APACHE_LOG_DIR}/test2.${DOMAIN}_error.log
    CustomLog \${APACHE_LOG_DIR}/test2.${DOMAIN}_access.log combined
</VirtualHost>
EOF

# Create phpMyAdmin virtual host
cat > /etc/apache2/sites-available/phpmyadmin.${DOMAIN}.conf <<EOF
<VirtualHost *:80>
    ServerName phpmyadmin.${DOMAIN}
    DocumentRoot /usr/share/phpmyadmin
    ErrorLog \${APACHE_LOG_DIR}/phpmyadmin.${DOMAIN}_error.log
    CustomLog \${APACHE_LOG_DIR}/phpmyadmin.${DOMAIN}_access.log combined
</VirtualHost>
EOF

# Create web directories and sample pages
echo_progress "Creating web directories and sample pages"

# Test1 site
mkdir -p /var/www/test1.${DOMAIN}
cat > /var/www/test1.${DOMAIN}/index.php <<EOF
<?php
phpinfo();
?>
EOF

# Test2 site
mkdir -p /var/www/test2.${DOMAIN}
cat > /var/www/test2.${DOMAIN}/index.php <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>Test2 Site</title>
</head>
<body>
    <h1>Welcome to Test2</h1>
    <?php
    echo "<p>Server Time: " . date('Y-m-d H:i:s') . "</p>";
    ?>
</body>
</html>
EOF

# Set permissions
echo_progress "Setting permissions"
chown -R ${USER}:www-data /var/www
find /var/www -type d -exec chmod 2775 {} \;
find /var/www -type f -exec chmod 0664 {} \;
usermod -a -G www-data ${USER}

# Enable sites and required modules
echo_progress "Enabling sites and modules"
a2ensite test1.${DOMAIN}
a2ensite test2.${DOMAIN}
a2ensite phpmyadmin.${DOMAIN}
a2enmod rewrite

# Install Ollama
echo_progress "Installing Ollama"
curl -fsSL https://ollama.ai/install.sh | sh

# Install OpenWebUI dependencies and OpenWebUI
echo_progress "Installing OpenWebUI"
apt install -y python3-pip
pip3 install open-webui
open-webui start

# Restart Apache
echo_progress "Restarting Apache"
systemctl restart apache2

# Display completion message and credentials
echo "============================================"
echo "Installation Complete!"
echo "============================================"
echo "MySQL root password: ${MYSQL_ROOT_PASSWORD}"
echo "phpMyAdmin user password: ${MYSQL_PHPMYADMIN_PASSWORD}"
echo ""
echo "Please add these entries to your hosts file or DNS:"
echo "127.0.0.1 test1.${DOMAIN}"
echo "127.0.0.1 test2.${DOMAIN}"
echo "127.0.0.1 phpmyadmin.${DOMAIN}"
echo ""
echo "Sites available at:"
echo "http://test1.${DOMAIN}"
echo "http://test2.${DOMAIN}"
echo "http://phpmyadmin.${DOMAIN}"
echo ""
echo "OpenWebUI should be available at http://localhost:8080"
echo "============================================"

# Save credentials to a secure file
echo_progress "Saving credentials to /root/.lamp_credentials"
cat > /root/.lamp_credentials <<EOF
MySQL Root Password: ${MYSQL_ROOT_PASSWORD}
phpMyAdmin User Password: ${MYSQL_PHPMYADMIN_PASSWORD}
EOF
chmod 600 /root/.lamp_credentials
